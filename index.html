<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <title>Cowin Vaccine Notifier</title>
    <style>
      .select2-container {
          width: 100% !important;
      }
    </style>
  </head>
  <body>
    <div class="container" style="margin-top: 10px;width: auto;">
        <div class="card" style="margin: auto; border: 2px solid black">
            <div class="card-header" style="background-color: lightblue">
                <h4><center>Cowin Vaccine Availability Notifier (18-44)</center></h4>
            </div>
            <div class="card-body">
              <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="pills-subscribe-tab" data-bs-toggle="pill" data-bs-target="#pills-subscribe" type="button" role="tab" aria-controls="pills-subscribe" aria-selected="true">Subscribe</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="pills-unsubscribe-tab" data-bs-toggle="pill" data-bs-target="#pills-unsubscribe" type="button" role="tab" aria-controls="pills-unsubscribe" aria-selected="false">Unsubscribe</button>
                </li>
              </ul>
              <div class="alert alert-danger" role="alert" style="display: none;">
              </div>
              <div class="tab-content" id="pills-tabContent">
                  <div id="pills-subscribe" class="tab-pane fade show active" role="tabpanel" aria-labelledby="pills-subscribe-tab">
                    <h4 id="details" style="display: none;">Your details have been registered.</h4>
                    <form id="cowinForm" method="POST" action="https://ag3l4lmj70.execute-api.ap-south-1.amazonaws.com/v1/register" novalidate>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radio-district" value="district">
                          <label class="form-check-label" for="radio-district">District</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radio-pincode" value="pincode">
                          <label class="form-check-label" for="radio-pincode">Pincode</label>
                        </div>
                        <br>
                        <br>
    
                        <div class="form-group pincode_div">
                          <label for="pincode">Enter pin code(s)</label>
                          <input type="text" required class="form-control" id="pincode" aria-describedby="pincodeHelp" placeholder="380015,380007">
                          <small id="pincodeHelp" class="form-text text-muted">You can enter multiple pin codes by separating them with a comma.</small>
                        </div>
                        <div class="form-group districts_div">
                          <label for="district">Select District(s)</label>
                            <select multiple required class="form-control" id="district" aria-describedby="districtHelp"></select>
                          <small id="districtHelp" class="form-text text-muted">You can select multiple districts.</small>
                        </div>
    
                        <br>
                        <div class="form-group">
                          <label for="email">Email</label>
                          <input type="email" required class="form-control" id="email" placeholder="Enter email">
                        </div>
                        <br>
                        <button type="submit" class="submitBtn btn btn-success">Notify Me!</button>
                    </form>
                  </div>
                <div id="pills-unsubscribe" class="tab-pane fade" role="tabpanel" aria-labelledby="pills-unsubscribe-tab">
                  <h4 id="unsubscribeDetails" style="display: none;">Your have been unsubscribed.</h4>
                  <form id="unsubscribeForm" method="POST" novalidate>
                    <div class="form-group">
                      <label for="unsubscribe-email">Email</label>
                      <input type="email" required class="form-control" id="unsubscribe-email" placeholder="Enter email">
                      <small style="color: red;">You will stop receiving mails from now on.</small>
                    </div>
                    <br>
                    <button type="submit" class="submitBtn btn btn-danger">Stop sending me mails!</button>
                  </form>
                </div>
              </div>
            </div>
            <div class="card-footer" style="display: none;">
                <h6>You will receive a mail as soon as a slot is available at any center for the given pincode/district.</h6>
                <h6>As slots get booked within seconds or minutes, please visit Aarogya Setu App or <a href="https://www.cowin.gov.in/home"  target="_blank">Cowin Website</a> as soon as you receive a notification.</h6>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="districts_data.js"></script>
    <script>
        var pinRegex =  /^[1-9][0-9]{5}$/
        var districtsUrl = "https://cowin-districts.s3.ap-south-1.amazonaws.com/districts_data.json"
        var filter_type = ""

        $(document).ready(function(){
            // $.ajax({
            //     url: districtsUrl,
            //     type: 'GET',
            //     dataType: 'json', // added data type
            //     success: function(res) {
            //           console.log(res)
                      
            //   }
            // });
            options = ""
            districtsData.forEach(item=>{
                options += `<option value='${item.district_id}'>${item.district_name}</option>`
            })
            $("#district").html(options).select2({})
            $("input[name='inlineRadioOptions'][value='district']").attr('checked', 'checked');
            $(".pincode_div").hide()
            filter_type = "district"
        });

        $('input[type=radio]').change(function() {
            if (this.value == 'district') {
                filter_type = "district"
                $(".districts_div").show()
                $(".pincode_div").hide()
            }
            else if (this.value == 'pincode') {
                filter_type = "pincode"
                $(".districts_div").hide()
                $(".pincode_div").show()
            }
        });

        $("#cowinForm").submit(function(e) {
            e.preventDefault();
            $(".alert").hide()

            var pincode = $("#pincode").val();
            var district = $("#district").val();
            var email = $("#email").val()

            if(!email){
                $(".alert").show()
                $(".alert").html("Email is required")
                return false
            }
            if(!isValidEmailAddress(email)){
              $(".alert").show()
              $(".alert").html("Invalid Email")
              return false
            }

            if(filter_type == "pincode"){
                if(!pincode){
                    $(".alert").show()
                    $(".alert").html("Pincode is required")
                    return false
                }

                pins = pincode.split(",")
                error_pin = false
                pins.forEach(pin=>{
                  pin = pin.trim()
                  if(!pinRegex.test(pin)){
                    error_pin = true;
                  }
                })

                if(error_pin){
                  $(".alert").show()
                  $(".alert").html("Invalid Pincode")
                  return false
                }
                district = []
            }
            else{
                if(!district || district.length == 0){
                    $(".alert").show()
                    $(".alert").html("District is required")
                    return false
                }
                pins = []
            }

            var form = $(this);
            var url = form.attr('action');

            $(".submitBtn").attr('disabled', true);
            $(".submitBtn").html("Please wait..")

            $.ajax({
                type: "POST",
                url: url,
                headers: {'Content-Type': 'application/json'},
                crossDomain: true,
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify({email, pincode: pins, district: district, filter_type: filter_type}),
                success: function (data) {
                    console.log('Submission was successful.');
                    $("form").hide()
                    $("#details").show()
                    $(".card-footer").show()
                },
                error: function (data) {
                    console.log(data.responseJSON)
                    $(".alert").show()
                    $(".alert").html(data.responseJSON.message)
                    $(".submitBtn").attr('disabled', false);
                    return false
                },
            });
            
            $("#submit").prop('disabled', false);
            return false
        });

        $("#unsubscribeForm").submit(function(e) {
            e.preventDefault();
            $(".alert").hide();
            var unEmail = $("#unsubscribe-email").val()
            var form = $(this);
            var url = form.attr('action');

            if(!unEmail){
                $(".alert").show()
                $(".alert").html("Email is required")
                return false
            }
            if(!isValidEmailAddress(unEmail)){
              $(".alert").show()
              $(".alert").html("Invalid Email")
              return false
            }

            $.ajax({
                type: "PATCH",
                url: "https://ag3l4lmj70.execute-api.ap-south-1.amazonaws.com/v1/unsubscribe",
                headers: {'Content-Type': 'application/json'},
                crossDomain: true,
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify({email:unEmail}),
                success: function (data) {
                    $("form").hide()
                    $("#unsubscribeDetails").show()
                },
                error: function (data) {
                    $(".alert").show()
                    $(".alert").html(data.responseJSON.message)
                    $(".submitBtn").attr('disabled', false);
                    return false
                },
            });
            
        })

        function isValidEmailAddress(emailAddress) {
            var pattern = /^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;
            return pattern.test(emailAddress);
        }

        
    </script>
  </body>
</html>