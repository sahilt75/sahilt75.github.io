<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <title>Cowin Vaccine Notifier</title>
  </head>
  <body>
    <div class="container" style="margin-top: 10px;">
        <div class="card" style="width: 50%;margin: auto">
            <div class="card-header">
                <h4><center>Cowin Vaccine Availability Notifier (18-44)</center></h4>
            </div>
            <div class="card-body">
                <h4 id="details" style="display: none;">Your details have been registered.</h4>
                <div class="alert alert-danger" role="alert" style="display: none;">
                </div>
                <form id="cowinForm" method="POST" action="https://ag3l4lmj70.execute-api.ap-south-1.amazonaws.com/v1/register">
                    <div class="form-group">
                      <label for="pincode">Enter pin code(s)</label>
                      <input type="text" required class="form-control" id="pincode" aria-describedby="pincodeHelp" placeholder="380015,380007">
                      <small id="pincodeHelp" class="form-text text-muted">You can enter multiple pin codes by separating them with a comma.</small>
                    </div>
                    <br>
                    <div class="form-group">
                      <label for="email">Email</label>
                      <input type="email" required class="form-control" id="email" placeholder="Enter email">
                    </div>
                    <br>
                    <div class="form-group">
                      <label for="phone">Phone</label>
                      <input type="phone" class="form-control" id="phone" placeholder="Enter phone (Optional)">
                    </div>
                    <br>
                    <button type="submit" class="submitBtn btn btn-primary">Notify Me!</button>
                </form>
            </div>
            <div class="card-footer" style="display: none;">
                <h6>You will receive a mail as soon as a slot is available at any center for the given pincode.</h6>
                <h6>Since slots get booked within seconds or minutes, please visit Aarogya Setu App or <a href="https://www.cowin.gov.in/home"  target="_blank">Cowin Website</a> as soon as you receive a notification.</h6>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script>
        var pinRegex =  /^[1-9][0-9]{5}$/
        $("#cowinForm").submit(function(e) {
            e.preventDefault(); 
            $(".submitBtn").attr('disabled', true);
            $(".alert").hide()
            
            var form = $(this);
            var url = form.attr('action');
            var pincode = $("#pincode").val()
            var email = $("#email").val()

            pins = pincode.split(",")
            error_pin = false
            pins.forEach(pin=>{
              pin = pin.trim()
              if(!pinRegex.test(pin)){
                error_pin = true;
              }
            })

            if(error_pin){
              $(".alert").show()
              $(".alert").html("Invalid Pincode")
              return false
            }

            $.ajax({
                type: "POST",
                url: url,
                headers: {'Content-Type': 'application/json'},
                crossDomain: true,
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify({email, pincode: pins.join(",")}),
                success: function (data) {
                    console.log('Submission was successful.');
                    $("form").hide()
                    $("#details").show()
                    $(".card-footer").show()

                },
                error: function (data) {
                    console.log(data.responseJSON)
                    $(".alert").show()
                    $(".alert").html(data.responseJSON.message)
                },
            });
            
            $("#submit").prop('disabled', false);
            return false
        });
    </script>
  </body>
</html>